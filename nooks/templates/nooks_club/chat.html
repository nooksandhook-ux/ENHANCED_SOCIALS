{% extends 'base.html' %}
{% block content %}
<div class="container">
  <h2>Club Chat: {{ club_name }}</h2>
  <nav class="mb-3">
    <a href="{{ url_for('nooks_club.view_club', club_id=club_id) }}" class="btn btn-outline-secondary">Back to {{ club_name }}</a>
  </nav>
  <div id="club-chat-box" data-club-id="{{ club_id }}">
    <div id="chat-box" class="card mb-2" style="height:300px;overflow-y:auto;"></div>
    <form id="chat-form" autocomplete="off">
      <input id="chat-input" type="text" class="form-control mb-2" placeholder="Type a message...">
      <input type="hidden" id="csrf_token" value="{{ csrf_token }}">
      <button class="btn btn-primary">Send</button>
    </form>
  </div>
</div>
{% block extra_scripts %}
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
function setupAdminMenuListeners() {
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.admin-menu-btn');
    if (btn) {
      e.stopPropagation();
      const menu = btn.nextElementSibling;
      if (menu && menu.classList.contains('admin-menu')) {
        document.querySelectorAll('.admin-menu.show').forEach(openMenu => {
          if (openMenu !== menu) {
            openMenu.classList.remove('show');
          }
        });
        menu.classList.toggle('show');
      }
    } else {
      document.querySelectorAll('.admin-menu.show').forEach(menu => {
        menu.classList.remove('show');
      });
    }
  });
}

const socket = io();
socket.on('connect', () => {
  socket.emit('join_club', { club_id: '{{ club_id }}', user_id: '{{ current_user.id }}', username: '{{ current_user.username }}' });
});
socket.on('chat_message', (data) => {
  const chatBox = document.getElementById('chat-box');
  const message = document.createElement('div');
  message.className = 'p-2 position-relative';
  message.innerHTML = `
    <p>${data.message} <small class="text-muted">by ${data.username}</small></p>
    {% if is_admin %}
    <div class="admin-actions">
      <button class="btn btn-sm btn-outline-secondary admin-menu-btn">...</button>
      <div class="admin-menu">
        <button class="btn btn-danger btn-sm" onclick="deleteMessage('${data.message_id}')">Delete</button>
      </div>
    </div>
    {% endif %}
  `;
  chatBox.appendChild(message);
  chatBox.scrollTop = chatBox.scrollHeight;
});
function loadMessages() {
  fetch('{{ url_for("nooks_club.api_get_club_chat", club_id=club_id) }}')
    .then(response => response.json())
    .then(data => {
      const chatBox = document.getElementById('chat-box');
      chatBox.innerHTML = '';
      if (data.messages) {
        data.messages.forEach(msg => {
          const message = document.createElement('div');
          message.className = 'p-2 position-relative';
          message.innerHTML = `
            <p>${msg.message} <small class="text-muted">by ${msg.username}</small></p>
            {% if is_admin %}
            <div class="admin-actions">
              <button class="btn btn-sm btn-outline-secondary admin-menu-btn">...</button>
              <div class="admin-menu">
                <button class="btn btn-danger btn-sm" onclick="deleteMessage('${msg._id}')">Delete</button>
              </div>
            </div>
            {% endif %}
          `;
          chatBox.appendChild(message);
        });
        chatBox.scrollTop = chatBox.scrollHeight;
      }
    })
    .catch(error => console.error('Error fetching messages:', error));
}
function deleteMessage(messageId) {
  if (confirm('Are you sure you want to delete this message?')) {
    fetch('{{ url_for("nooks_club.api_delete_club_message", club_id=club_id, message_id="") }}' + messageId, { 
      method: 'DELETE',
      headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    })
      .then(response => response.json())
      .then(data => {
        if (data.message) {
          alert('Message deleted successfully');
          loadMessages();
        } else {
          alert(data.error || 'Error deleting message');
        }
      })
      .catch(error => console.error('Error deleting message:', error));
  }
}
document.getElementById('chat-form').addEventListener('submit', (e) => {
  e.preventDefault();
  const message = document.getElementById('chat-input').value;
  const csrfToken = document.getElementById('csrf_token').value;
  if (message.trim()) {
    fetch('{{ url_for("nooks_club.api_send_club_chat", club_id=club_id) }}', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({ message })
    })
      .then(response => response.json())
      .then(data => {
        if (data.message_id) {
          document.getElementById('chat-input').value = '';
          socket.emit('chat_message', { 
            club_id: '{{ club_id }}', 
            message: message, 
            user_id: '{{ current_user.id }}', 
            username: '{{ current_user.username }}',
            message_id: data.message_id 
          });
        } else {
          alert(data.error || 'Error sending message');
        }
      })
      .catch(error => console.error('Error sending message:', error));
  }
});
document.addEventListener('DOMContentLoaded', () => {
  loadMessages();
  setupAdminMenuListeners();
});
</script>
{% endblock %}
{% endblock %}
