{% extends "base.html" %}

{% block title %}Book Details - {{ book.title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Book Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-success">
            <i class="bi bi-book me-2"></i>{{ book.title }}
        </h1>
        <a href="{{ url_for('nook.index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Back to Library
        </a>
    </div>

    <!---Book Details -->
    <div class="row">
        <!-- Book Cover and Info -->
        <div class="col-md-4">
            <div class="card shadow-sm mb-4">
                <img src="{{ book.cover_image or '/static/images/default-book-cover.png' }}" 
                     class="card-img-top img-fluid" 
                     style="max-height: 400px; object-fit: cover;" 
                     alt="{{ book.title }}">
                <div class="card-body">
            {% if book.pdf_path %}
            <div class="mb-3">
                <a href="#" class="btn btn-primary" id="read-now-btn">
                    <i class="bi bi-file-earmark-pdf me-2"></i>Read Now
                </a>
            </div>
            {% endif %}
                    <h5 class="card-title">{{ book.title }}</h5>
                    <p class="card-text text-muted">by {{ book.authors | join(', ') }}</p>
                    {% if book.genre %}
                        <p class="card-text"><strong>Genre:</strong> {{ book.genre }}</p>
                    {% endif %}
                    {% if book.isbn %}
                        <p class="card-text"><strong>ISBN:</strong> {{ book.isbn }}</p>
                    {% endif %}
                    {% if book.published_date %}
                        <p class="card-text"><strong>Published:</strong> {{ book.published_date }}</p>
                    {% endif %}
                    <p class="card-text"><strong>Pages:</strong> {{ book.page_count }}</p>
                    <p class="card-text">
                        <strong>Status:</strong> 
                        <span class="badge 
                            {% if book.status == 'reading' %}bg-warning
                            {% elif book.status == 'finished' %}bg-success
                            {% else %}bg-secondary{% endif %}">
                            {{ book.status.title() }}
                        </span>
                    </p>
                    {% if book.rating > 0 %}
                        <p class="card-text">
                            <strong>Rating:</strong> 
                            {% for i in range(book.rating) %}
                                <i class="bi bi-star-fill text-warning"></i>
                            {% endfor %}
                            {% for i in range(5 - book.rating) %}
                                <i class="bi bi-star text-muted"></i>
                            {% endfor %}
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Book Progress and Actions -->
        <div class="col-md-8">
            <!-- Progress -->
            {% if book.page_count > 0 %}
                <div class="card mb-4 shadow-sm">
                    <div class="card-body">
                        <h5>Reading Progress</h5>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar" 
                                 style="width: {{ (book.current_page / book.page_count * 100) | round(1) }}%">
                            </div>
                        </div>
                        <small class="text-muted mt-2 d-block">
                            {{ book.current_page }} / {{ book.page_count }} pages
                            ({{ (book.current_page / book.page_count * 100) | round(1) }}%)
                        </small>
                    </div>
                </div>
            {% endif %}

            <!-- Update Progress Form -->
            {% if update_form %}
                <div class="card mb-4 shadow-sm">
                    <div class="card-body">
                        <h5>Update Progress</h5>
                        <form action="{{ url_for('nook.update_progress', book_id=book._id) }}" method="POST" id="update-progress-form">
                            {{ update_form.hidden_tag() }}
                            <div class="mb-3">
                                {{ update_form.current_page.label(class="form-label") }}
                                {{ update_form.current_page(class="form-control", id="current_page", min="0", max=book.page_count, value=book.current_page, required=True) }}
                                {% if update_form.current_page.errors %}
                                    <ul class="text-danger">
                                        {% for error in update_form.current_page.errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                {{ update_form.duration_minutes.label(class="form-label") }}
                                {{ update_form.duration_minutes(class="form-control", id="duration_minutes", min="0", value="0") }}
                                {% if update_form.duration_minutes.errors %}
                                    <ul class="text-danger">
                                        {% for error in update_form.duration_minutes.errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                {{ update_form.session_notes.label(class="form-label") }}
                                {{ update_form.session_notes(class="form-control", id="session_notes", rows="3") }}
                                {% if update_form.session_notes.errors %}
                                    <ul class="text-danger">
                                        {% for error in update_form.session_notes.errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check-circle me-2"></i>Update Progress
                            </button>
                        </form>
                    </div>
                </div>
            {% endif %}

            <!-- Rate Book Form -->
            {% if rate_form %}
                <div class="card mb-4 shadow-sm">
                    <div class="card-body">
                        <h5>Rate Book</h5>
                        <form action="{{ url_for('nook.rate_book', book_id=book._id) }}" method="POST" id="rate-book-form">
                            {{ rate_form.hidden_tag() }}
                            <div class="mb-3">
                                {{ rate_form.rating.label(class="form-label") }}
                                {{ rate_form.rating(class="form-control", id="rating", required=True) }}
                                {% if rate_form.rating.errors %}
                                    <ul class="text-danger">
                                        {% for error in rate_form.rating.errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                {{ rate_form.review.label(class="form-label") }}
                                {{ rate_form.review(class="form-control", id="review", rows="3", value=book.review or '') }}
                                {% if rate_form.review.errors %}
                                    <ul class="text-danger">
                                        {% for error in rate_form.review.errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-star-fill me-2"></i>Submit Rating
                            </button>
                        </form>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Description -->
    {% if book.description %}
        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <h5>Description</h5>
                <p>{{ book.description }}</p>
            </div>
        </div>
    {% endif %}

    <!-- Key Takeaways -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <h5>Key Takeaways</h5>
            {% if book.key_takeaways %}
                <ul class="list-group list-group-flush">
                    {% for takeaway in book.key_takeaways %}
                        <li class="list-group-item">
                            <p class="mb-1">{{ takeaway.text }}</p>
                            {% if takeaway.page_reference %}
                                <small class="text-muted">Page: {{ takeaway.page_reference }} | Added: {{ takeaway.date.strftime('%Y-%m-%d') }}</small>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted">No key takeaways added yet.</p>
            {% endif %}
            <!-- Add Takeaway Form -->
            {% if takeaway_form %}
                <form action="{{ url_for('nook.add_takeaway', book_id=book._id) }}" method="POST" class="mt-3" id="add-takeaway-form">
                    {{ takeaway_form.hidden_tag() }}
                    <div class="mb-3">
                        {{ takeaway_form.takeaway.label(class="form-label") }}
                        {{ takeaway_form.takeaway(class="form-control", id="takeaway", rows="2", required=True) }}
                        {% if takeaway_form.takeaway.errors %}
                            <ul class="text-danger">
                                {% for error in takeaway_form.takeaway.errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        {{ takeaway_form.page_reference.label(class="form-label") }}
                        {{ takeaway_form.page_reference(class="form-control", id="page_reference") }}
                        {% if takeaway_form.page_reference.errors %}
                            <ul class="text-danger">
                                {% for error in takeaway_form.page_reference.errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-plus-circle me-2"></i>Add Takeaway
                    </button>
                </form>
            {% endif %}
        </div>
    </div>

    <!-- Quotes -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <h5>Quotes</h5>
            {% if book.quotes %}
                <ul class="list-group list-group-flush">
                    {% for quote in book.quotes %}
                        <li class="list-group-item">
                            <blockquote class="blockquote mb-1">
                                <p>{{ quote.text }}</p>
                            </blockquote>
                            {% if quote.page or quote.context %}
                                <small class="text-muted">
                                    {% if quote.page %}Page: {{ quote.page }}{% if quote.context %}, {% endif %}{% endif %}
                                    {% if quote.context %}Context: {{ quote.context }}{% endif %}
                                    | Added: {{ quote.date.strftime('%Y-%m-%d') }}
                                </small>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted">No quotes added yet.</p>
            {% endif %}
            <!-- Add Quote Form -->
            {% if quote_form %}
                <form action="{{ url_for('nook.add_quote', book_id=book._id) }}" method="POST" class="mt-3" id="add-quote-form">
                    {{ quote_form.hidden_tag() }}
                    <div class="mb-3">
                        {{ quote_form.quote.label(class="form-label") }}
                        {{ quote_form.quote(class="form-control", id="quote", rows="2", required=True) }}
                        {% if quote_form.quote.errors %}
                            <ul class="text-danger">
                                {% for error in quote_form.quote.errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        {{ quote_form.page.label(class="form-label") }}
                        {{ quote_form.page(class="form-control", id="page") }}
                        {% if quote_form.page.errors %}
                            <ul class="text-danger">
                                {% for error in quote_form.page.errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        {{ quote_form.context.label(class="form-label") }}
                        {{ quote_form.context(class="form-control", id="context", rows="2") }}
                        {% if quote_form.context.errors %}
                            <ul class="text-danger">
                                {% for error in quote_form.context.errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-quote me-2"></i>Add Quote
                    </button>
                </form>
            {% endif %}
        </div>
    </div>

    <!-- Reading Sessions -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <h5>Reading Sessions</h5>
            {% if reading_sessions %}
                <ul class="list-group list-group-flush">
                    {% for session in reading_sessions %}
                        <li class="list-group-item">
                            <p class="mb-1">
                                <strong>{{ session.date.strftime('%Y-%m-%d %H:%M') }}</strong>
                                | Pages: {{ session.start_page }} - {{ session.end_page }} ({{ session.pages_read }} pages)
                                | Duration: {{ session.duration_minutes }} minutes
                            </p>
                            {% if session.notes %}
                                <p class="mb-0">{{ session.notes }}</p>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted">No reading sessions recorded.</p>
            {% endif %}
        </div>
    </div>

    <!-- Notes -->
    {% if book.notes %}
        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <h5>Notes</h5>
                <p>{{ book.notes }}</p>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% if book.pdf_path %}
<!-- PDF.js and PDF Viewer Modal -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="/static/js/pdf_viewer.js"></script>

<div class="modal fade" id="pdfViewerModal" tabindex="-1" aria-labelledby="pdfViewerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pdfViewerModalLabel">Read: {{ book.title }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <button id="prev" class="btn btn-outline-secondary btn-sm">Previous</button>
                        <button id="next" class="btn btn-outline-secondary btn-sm">Next</button>
                        <span class="mx-2">Page: <span id="page_num"></span> / <span id="page_count"></span></span>
                    </div>
                </div>
                <canvas id="the-canvas" style="border:1px solid #ccc; width:100%; max-width:100%;"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const readNowBtn = document.getElementById('read-now-btn');
    if (readNowBtn) {
        readNowBtn.addEventListener('click', function(e) {
            e.preventDefault();
            let pdfUrl = '{{ url_for("nook.serve_pdf", book_id=book._id) }}';
            let bookId = '{{ book._id }}';
            let modal = new bootstrap.Modal(document.getElementById('pdfViewerModal'));
            modal.show();
            setTimeout(function() {
                setupPdfViewer(pdfUrl, bookId);
            }, 500);
        });
    }

    // Client-side validation for Update Progress form
    const updateForm = document.getElementById('update-progress-form');
    if (updateForm) {
        updateForm.addEventListener('submit', function(e) {
            const currentPage = document.getElementById('current_page').value;
            const maxPage = {{ book.page_count }};
            const durationMinutes = document.getElementById('duration_minutes').value;
            
            if (currentPage < 0 || currentPage > maxPage) {
                e.preventDefault();
                alert('Current page must be between 0 and ' + maxPage + '.');
                return;
            }
            if (durationMinutes < 0) {
                e.preventDefault();
                alert('Duration cannot be negative.');
                return;
            }
        });
    }

    // Client-side validation for Add Takeaway form
    const takeawayForm = document.getElementById('add-takeaway-form');
    if (takeawayForm) {
        takeawayForm.addEventListener('submit', function(e) {
            const takeaway = document.getElementById('takeaway').value.trim();
            if (!takeaway) {
                e.preventDefault();
                alert('Key takeaway is required.');
                return;
            }
        });
    }

    // Client-side validation for Add Quote form
    const quoteForm = document.getElementById('add-quote-form');
    if (quoteForm) {
        quoteForm.addEventListener('submit', function(e) {
            const quote = document.getElementById('quote').value.trim();
            if (!quote) {
                e.preventDefault();
                alert('Quote is required.');
                return;
            }
        });
    }

    // Client-side validation for Rate Book form
    const rateForm = document.getElementById('rate-book-form');
    if (rateForm) {
        rateForm.addEventListener('submit', function(e) {
            const rating = document.getElementById('rating').value;
            if (!rating) {
                e.preventDefault();
                alert('Rating is required.');
                return;
            }
        });
    }
});
</script>
{% endif %}
