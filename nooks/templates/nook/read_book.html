{% extends "base.html" %}
{% block title %}Read: {{ book.title }}{% endblock %}
{% block content %}
<div class="container mt-4">
    <h1 class="mb-4 text-success"><i class="bi bi-book me-2"></i>Reading: {{ book.title }}</h1>
    <div class="mb-3 d-flex justify-content-between align-items-center">
        <a href="{{ url_for('nook.book_detail', book_id=book._id) }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Back to Book Details
        </a>
        <div class="btn-group">
            <button id="prev-page" class="btn btn-outline-primary btn-sm"><i class="bi bi-chevron-left"></i> Previous</button>
            <button id="next-page" class="btn btn-outline-primary btn-sm">Next <i class="bi bi-chevron-right"></i></button>
        </div>
    </div>
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="text-center mb-3">
                <span id="page-info">Page <span id="current-page">1</span> of <span id="total-pages">1</span></span>
            </div>
            <div style="position: relative; width: 100%; height: 80vh; overflow: auto;">
                <canvas id="pdf-canvas" class="mx-auto d-block"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.min.mjs" type="module"></script>
<script type="module">
    import * as pdfjsLib from 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.min.mjs';

    // Set the worker source for PDF.js
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.worker.min.mjs';

    // PDF viewer setup
    const pdfUrl = "{{ pdf_url | safe }}";
    const canvas = document.getElementById('pdf-canvas');
    const context = canvas.getContext('2d');
    let pdfDoc = null;
    let pageNum = {{ book.current_page | default(1) }};
    let pageRendering = false;
    let pageNumPending = null;
    const scale = 1.5; // Adjust zoom level as needed

    const currentPageSpan = document.getElementById('current-page');
    const totalPagesSpan = document.getElementById('total-pages');

    // Render a specific page
    async function renderPage(num) {
        if (pageRendering) {
            pageNumPending = num;
            return;
        }
        pageRendering = true;

        try {
            const page = await pdfDoc.getPage(num);
            const viewport = page.getViewport({ scale: scale });

            // Adjust canvas size
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            // Render PDF page
            await page.render({
                canvasContext: context,
                viewport: viewport
            }).promise;

            // Update page info
            currentPageSpan.textContent = num;
            totalPagesSpan.textContent = pdfDoc.numPages;

            pageRendering = false;

            // Render pending page if any
            if (pageNumPending !== null) {
                renderPage(pageNumPending);
                pageNumPending = null;
            }
        } catch (error) {
            console.error('Error rendering page:', error);
            pageRendering = false;
        }
    }

    // Load the PDF
    async function loadPdf() {
        try {
            pdfDoc = await pdfjsLib.getDocument(pdfUrl).promise;
            renderPage(pageNum);
        } catch (error) {
            console.error('Error loading PDF:', error);
            alert('Failed to load the PDF. Please try again.');
        }
    }

    // Navigation button handlers
    document.getElementById('prev-page').addEventListener('click', () => {
        if (pageNum <= 1) return;
        pageNum--;
        renderPage(pageNum);
    });

    document.getElementById('next-page').addEventListener('click', () => {
        if (pageNum >= pdfDoc.numPages) return;
        pageNum++;
        renderPage(pageNum);
    });

    // Initialize the PDF viewer
    loadPdf();
</script>
{% endblock %}
